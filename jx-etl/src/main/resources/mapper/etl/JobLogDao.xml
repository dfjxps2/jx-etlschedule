<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="io.dfjx.modules.etl.dao.JobLogDao">

	<!-- 可根据自己的需求，是否要使用 -->
    <resultMap type="io.dfjx.modules.etl.entity.JobLogEntity" id="jobLogMap">
        <result property="id" column="ID"/>
        <result property="etlSystem" column="ETL_System"/>
        <result property="etlJob" column="ETL_Job"/>
        <result property="jobsessionid" column="JobSessionID"/>
        <result property="jobstepid" column="JobStepID"/>
        <result property="scriptfile" column="ScriptFile"/>
        <result property="txdate" column="TXDate"/>
        <result property="starttime" column="StartTime"/>
        <result property="endtime" column="EndTime"/>
        <result property="returncode" column="ReturnCode"/>
        <result property="seconds" column="Seconds"/>
    </resultMap>


    <select id="queryLineChartData" resultType="map">
        select endtime,
        sum(case when returncode = 0 then 1 else 0 end) as success_cnt,
        sum(case when returncode > 0 then 1 else 0 end) as err_cnt
        from etl_job_log
        where txdate >= #{fromDate} and txdate &lt;= #{toDate}
        group by txdate
        order by txdate
	</select>

    <select id="queryPieChartData" resultType="map">
        select endtime, sum(case when returncode = 0 then 1 else 0 end) as success_cnt,
       sum(case when returncode > 0 then 1 else 0 end) as err_cnt,
       count(1)
        from etl_job_log
        where endtime >= #{fromDate} and txdate &lt;= #{toDate}
        group by endtime
        order by endtime
    </select>
</mapper>
